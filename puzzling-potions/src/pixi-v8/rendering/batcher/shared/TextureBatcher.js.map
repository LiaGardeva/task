{"version":3,"file":"TextureBatcher.js","sources":["../../../../src/rendering/batcher/shared/TextureBatcher.ts"],"sourcesContent":["import { MAX_TEXTURES } from './const';\nimport { optimizeBindings } from './optimizeBindings';\n\nimport type { BindGroup } from '../../renderers/gpu/shader/BindGroup';\nimport type { TextureSource } from '../../renderers/shared/texture/sources/TextureSource';\nimport type { BindableTexture } from '../../renderers/shared/texture/Texture';\nimport type { TextureBatch } from './Batcher';\n\nconst batchPool: TextureBatchOutput[] = [];\nlet batchPoolIndex = 0;\n\nexport class TextureBatchOutput implements TextureBatch\n{\n    textures: TextureSource[] = [];\n    bindGroup: BindGroup;\n    size = 0;\n    batchLocations: Record<number, number> = {};\n}\n\nexport class TextureBatcher\n{\n    textureTicks: Record<number, number> = {};\n\n    tick = 1000;\n\n    output: TextureBatch;\n    bindingOffset: number;\n\n    begin()\n    {\n        batchPoolIndex = 0;\n\n        this.bindingOffset = 0;\n        this.reset();\n    }\n\n    reset()\n    {\n        this.tick++;\n\n        this.output = batchPool[batchPoolIndex++] || new TextureBatchOutput();\n\n        this.output.size = 0;\n    }\n\n    finish(previousBatch?: TextureBatch)\n    {\n        // TODO make sure to add empty textures to the batch.\n\n        let output = this.output;\n\n        // TODO this should never have length 0.. need to investigate..\n        if (previousBatch && previousBatch.textures.length && output.textures.length)\n        {\n            output = optimizeBindings(previousBatch, output, this.tick, this.bindingOffset++);\n        }\n\n        this.reset();\n\n        return output;\n    }\n\n    add(texture: BindableTexture): boolean\n    {\n        const tick = this.tick;\n        const textureTicks = this.textureTicks;\n\n        if (textureTicks[texture.styleSourceKey] === tick) return true;\n\n        const styleSourceKey = texture.styleSourceKey;\n        const output = this.output;\n\n        if (output.size === MAX_TEXTURES) return false;\n\n        output.textures[output.size] = texture;\n\n        textureTicks[styleSourceKey] = tick;\n\n        output.batchLocations[styleSourceKey] = output.size++;\n\n        batchPoolIndex = 0;\n\n        return true;\n    }\n\n    destroy()\n    {\n        this.output = null;\n        this.textureTicks = null;\n    }\n}\n"],"names":["optimizeBindings","MAX_TEXTURES"],"mappings":";;;;;;;AAQA,MAAM,YAAkC,EAAC,CAAA;AACzC,IAAI,cAAiB,GAAA,CAAA,CAAA;AAEd,MAAM,kBACb,CAAA;AAAA,EADO,WAAA,GAAA;AAEH,IAAA,IAAA,CAAA,QAAA,GAA4B,EAAC,CAAA;AAE7B,IAAO,IAAA,CAAA,IAAA,GAAA,CAAA,CAAA;AACP,IAAA,IAAA,CAAA,cAAA,GAAyC,EAAC,CAAA;AAAA,GAAA;AAC9C,CAAA;AAEO,MAAM,cACb,CAAA;AAAA,EADO,WAAA,GAAA;AAEH,IAAA,IAAA,CAAA,YAAA,GAAuC,EAAC,CAAA;AAExC,IAAO,IAAA,CAAA,IAAA,GAAA,GAAA,CAAA;AAAA,GAAA;AAAA,EAKP,KACA,GAAA;AACI,IAAiB,cAAA,GAAA,CAAA,CAAA;AAEjB,IAAA,IAAA,CAAK,aAAgB,GAAA,CAAA,CAAA;AACrB,IAAA,IAAA,CAAK,KAAM,EAAA,CAAA;AAAA,GACf;AAAA,EAEA,KACA,GAAA;AACI,IAAK,IAAA,CAAA,IAAA,EAAA,CAAA;AAEL,IAAA,IAAA,CAAK,MAAS,GAAA,SAAA,CAAU,cAAgB,EAAA,CAAA,IAAK,IAAI,kBAAmB,EAAA,CAAA;AAEpE,IAAA,IAAA,CAAK,OAAO,IAAO,GAAA,CAAA,CAAA;AAAA,GACvB;AAAA,EAEA,OAAO,aACP,EAAA;AAGI,IAAA,IAAI,SAAS,IAAK,CAAA,MAAA,CAAA;AAGlB,IAAA,IAAI,iBAAiB,aAAc,CAAA,QAAA,CAAS,MAAU,IAAA,MAAA,CAAO,SAAS,MACtE,EAAA;AACI,MAAA,MAAA,GAASA,kCAAiB,aAAe,EAAA,MAAA,EAAQ,IAAK,CAAA,IAAA,EAAM,KAAK,aAAe,EAAA,CAAA,CAAA;AAAA,KACpF;AAEA,IAAA,IAAA,CAAK,KAAM,EAAA,CAAA;AAEX,IAAO,OAAA,MAAA,CAAA;AAAA,GACX;AAAA,EAEA,IAAI,OACJ,EAAA;AACI,IAAA,MAAM,OAAO,IAAK,CAAA,IAAA,CAAA;AAClB,IAAA,MAAM,eAAe,IAAK,CAAA,YAAA,CAAA;AAE1B,IAAI,IAAA,YAAA,CAAa,OAAQ,CAAA,cAAc,CAAM,KAAA,IAAA;AAAM,MAAO,OAAA,IAAA,CAAA;AAE1D,IAAA,MAAM,iBAAiB,OAAQ,CAAA,cAAA,CAAA;AAC/B,IAAA,MAAM,SAAS,IAAK,CAAA,MAAA,CAAA;AAEpB,IAAA,IAAI,OAAO,IAAS,KAAAC,mBAAA;AAAc,MAAO,OAAA,KAAA,CAAA;AAEzC,IAAO,MAAA,CAAA,QAAA,CAAS,MAAO,CAAA,IAAI,CAAI,GAAA,OAAA,CAAA;AAE/B,IAAA,YAAA,CAAa,cAAc,CAAI,GAAA,IAAA,CAAA;AAE/B,IAAO,MAAA,CAAA,cAAA,CAAe,cAAc,CAAA,GAAI,MAAO,CAAA,IAAA,EAAA,CAAA;AAE/C,IAAiB,cAAA,GAAA,CAAA,CAAA;AAEjB,IAAO,OAAA,IAAA,CAAA;AAAA,GACX;AAAA,EAEA,OACA,GAAA;AACI,IAAA,IAAA,CAAK,MAAS,GAAA,IAAA,CAAA;AACd,IAAA,IAAA,CAAK,YAAe,GAAA,IAAA,CAAA;AAAA,GACxB;AACJ;;;;;"}