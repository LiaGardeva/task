{"version":3,"file":"GlStencilSystem.js","sources":["../../../../src/rendering/renderers/gl/GlStencilSystem.ts"],"sourcesContent":["import { ExtensionType } from '../../../extensions/Extensions';\nimport { GpuStencilModesToPixi } from '../gpu/state/GpuStencilModesToPixi';\nimport { STENCIL_MODES } from '../shared/state/const';\n\nimport type { RenderTarget } from '../shared/renderTarget/RenderTarget';\nimport type { System } from '../shared/system/System';\nimport type { WebGLRenderer } from './WebGLRenderer';\n\nexport class GlStencilSystem implements System\n{\n    /** @ignore */\n    static extension = {\n        type: [\n            ExtensionType.WebGLSystem,\n        ],\n        name: 'stencil',\n    } as const;\n\n    private gl: WebGLRenderingContext;\n\n    private stencilCache = {\n        enabled: false,\n        stencilReference: 0,\n    };\n\n    private renderTargetStencilState: Record<number, {\n        stencilMode: STENCIL_MODES;\n        stencilReference: number;\n    }> = {};\n\n    private stencilOpsMapping: {\n        keep: number;\n        zero: number;\n        replace: number;\n        invert: number;\n        'increment-clamp': number;\n        'decrement-clamp': number;\n        'increment-wrap': number;\n        'decrement-wrap': number;\n    };\n\n    private comparisonFuncMapping: {\n        always: number;\n        never: number;\n        equal: number;\n        'not-equal': number;\n        less: number;\n        'less-equal': number;\n        greater: number;\n        'greater-equal': number;\n    };\n\n    private activeRenderTarget: RenderTarget;\n\n    constructor(renderer: WebGLRenderer)\n    {\n        renderer.renderTarget.onRenderTargetChange.add(this);\n    }\n\n    protected contextChange(gl: WebGLRenderingContext)\n    {\n        // TODO - this could be declared in a gl const\n        // we know the numbers don't tend to change!\n        this.gl = gl;\n\n        this.comparisonFuncMapping = {\n            always: gl.ALWAYS,\n            never: gl.NEVER,\n            equal: gl.EQUAL,\n            'not-equal': gl.NOTEQUAL,\n            less: gl.LESS,\n            'less-equal': gl.LEQUAL,\n            greater: gl.GREATER,\n            'greater-equal': gl.GEQUAL,\n        };\n\n        this.stencilOpsMapping = {\n            keep: gl.KEEP,\n            zero: gl.ZERO,\n            replace: gl.REPLACE,\n            invert: gl.INVERT,\n            'increment-clamp': gl.INCR,\n            'decrement-clamp': gl.DECR,\n            'increment-wrap': gl.INCR_WRAP,\n            'decrement-wrap': gl.DECR_WRAP,\n        };\n    }\n\n    onRenderTargetChange(renderTarget: RenderTarget)\n    {\n        this.activeRenderTarget = renderTarget;\n\n        let stencilState = this.renderTargetStencilState[renderTarget.uid];\n\n        if (!stencilState)\n        {\n            stencilState = this.renderTargetStencilState[renderTarget.uid] = {\n                stencilMode: STENCIL_MODES.DISABLED,\n                stencilReference: 0,\n            };\n        }\n\n        // restore the current render targets stencil state..\n        this.setStencilMode(stencilState.stencilMode, stencilState.stencilReference);\n    }\n\n    setStencilMode(stencilMode: STENCIL_MODES, stencilReference: number)\n    {\n        const stencilState = this.renderTargetStencilState[this.activeRenderTarget.uid];\n\n        // store the stencil state for restoration later, if a render target changes\n        stencilState.stencilMode = stencilMode;\n        stencilState.stencilReference = stencilReference;\n\n        const mode = GpuStencilModesToPixi[stencilMode];\n\n        const gl = this.gl;\n\n        if (stencilMode === STENCIL_MODES.DISABLED)\n        {\n            if (this.stencilCache.enabled)\n            {\n                this.stencilCache.enabled = false;\n\n                gl.disable(gl.STENCIL_TEST);\n            }\n\n            return;\n        }\n\n        if (!this.stencilCache.enabled)\n        {\n            this.stencilCache.enabled = true;\n            gl.enable(gl.STENCIL_TEST);\n        }\n\n        // this is pretty simple mapping.\n        // will work for pixi's simple mask cases.\n        // although a true mapping of the GPU state to webGL state should be done\n        gl.stencilFunc(this.comparisonFuncMapping[mode.stencilBack.compare], stencilReference, 0xFF);\n        gl.stencilOp(gl.KEEP, gl.KEEP, this.stencilOpsMapping[mode.stencilBack.passOp]);\n    }\n\n    destroy()\n    {\n        // boom!\n    }\n}\n"],"names":["STENCIL_MODES","GpuStencilModesToPixi","ExtensionType"],"mappings":"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"}