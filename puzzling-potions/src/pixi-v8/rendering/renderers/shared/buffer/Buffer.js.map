{"version":3,"file":"Buffer.js","sources":["../../../../../src/rendering/renderers/shared/buffer/Buffer.ts"],"sourcesContent":["import EventEmitter from 'eventemitter3';\nimport { generateUID } from '../texture/utils/generateUID';\n\nimport type { BindResource } from '../../gpu/shader/BindResource';\nimport type { BufferUsage } from './const';\n\n// eslint-disable-next-line max-len\nexport type TypedArray = Int8Array | Uint8Array | Int16Array | Uint16Array | Int32Array | Uint32Array | Uint8ClampedArray | Float32Array | Float64Array;\n\nlet UID = 0;\n\nexport interface BufferOptions\n{\n    data?: TypedArray | number[];\n    size?: number;\n    usage: number;\n    label?: string;\n}\n\nexport interface BufferDescriptor\n{\n\n    label?: string;\n    size: GPUSize64;\n    usage: BufferUsage;\n    mappedAtCreation?: boolean;\n}\n\nexport class Buffer extends EventEmitter<{\n    change: BindResource,\n    update: Buffer,\n    destroy: Buffer,\n}> implements BindResource\n{\n    readonly resourceType = 'buffer';\n    resourceId = generateUID();\n\n    readonly uid = UID++;\n\n    descriptor: BufferDescriptor;\n\n    _updateID = 1;\n    _updateSize: number;\n\n    // TODO we should only need to resize a buffer if it gets Bigger..!\n    // private _maximumSize: number = 0;\n    private _data: TypedArray;\n\n    constructor({ data, size, usage, label }: BufferOptions)\n    {\n        super();\n\n        if (data instanceof Array)\n        {\n            data = new Float32Array(data as number[]);\n        }\n\n        this._data = data as TypedArray;\n\n        size = size ?? (data as TypedArray)?.byteLength;\n\n        const mappedAtCreation = !!data;\n\n        this.descriptor = {\n            size,\n            usage,\n            mappedAtCreation,\n            label,\n        };\n    }\n\n    get data()\n    {\n        return this._data;\n    }\n\n    set data(value: TypedArray)\n    {\n        if (this._data !== value)\n        {\n            const oldData = this._data;\n\n            this._data = value;\n\n            if (oldData.length !== value.length)\n            {\n                this.descriptor.size = value.byteLength;\n                this.resourceId = generateUID();\n\n                this.emit('change', this);\n            }\n            else\n            {\n                this.emit('update', this);\n            }\n        }\n    }\n\n    update(sizeInBytes?: number): void\n    {\n        this._updateSize = sizeInBytes || this.descriptor.size;\n        this._updateID++;\n\n        this.emit('update', this);\n    }\n\n    destroy()\n    {\n        this.emit('destroy', this);\n\n        this._data = null;\n        this.descriptor = null;\n\n        this.removeAllListeners();\n    }\n}\n\n"],"names":["EventEmitter","generateUID"],"mappings":";;;;;;;;;;;AASA,IAAI,GAAM,GAAA,CAAA,CAAA;AAmBH,MAAM,eAAeA,gCAK5B,CAAA;AAAA,EAeI,YAAY,EAAE,IAAA,EAAM,IAAM,EAAA,KAAA,EAAO,OACjC,EAAA;AACI,IAAM,KAAA,EAAA,CAAA;AAhBV,IAAA,IAAA,CAAS,YAAe,GAAA,QAAA,CAAA;AACxB,IAAA,IAAA,CAAA,UAAA,GAAaC,uBAAY,EAAA,CAAA;AAEzB,IAAA,IAAA,CAAS,GAAM,GAAA,GAAA,EAAA,CAAA;AAIf,IAAY,IAAA,CAAA,SAAA,GAAA,CAAA,CAAA;AAWR,IAAA,IAAI,gBAAgB,KACpB,EAAA;AACI,MAAO,IAAA,GAAA,IAAI,aAAa,IAAgB,CAAA,CAAA;AAAA,KAC5C;AAEA,IAAA,IAAA,CAAK,KAAQ,GAAA,IAAA,CAAA;AAEb,IAAA,IAAA,GAAO,QAAS,IAAqB,EAAA,UAAA,CAAA;AAErC,IAAM,MAAA,gBAAA,GAAmB,CAAC,CAAC,IAAA,CAAA;AAE3B,IAAA,IAAA,CAAK,UAAa,GAAA;AAAA,MACd,IAAA;AAAA,MACA,KAAA;AAAA,MACA,gBAAA;AAAA,MACA,KAAA;AAAA,KACJ,CAAA;AAAA,GACJ;AAAA,EAEA,IAAI,IACJ,GAAA;AACI,IAAA,OAAO,IAAK,CAAA,KAAA,CAAA;AAAA,GAChB;AAAA,EAEA,IAAI,KAAK,KACT,EAAA;AACI,IAAI,IAAA,IAAA,CAAK,UAAU,KACnB,EAAA;AACI,MAAA,MAAM,UAAU,IAAK,CAAA,KAAA,CAAA;AAErB,MAAA,IAAA,CAAK,KAAQ,GAAA,KAAA,CAAA;AAEb,MAAI,IAAA,OAAA,CAAQ,MAAW,KAAA,KAAA,CAAM,MAC7B,EAAA;AACI,QAAK,IAAA,CAAA,UAAA,CAAW,OAAO,KAAM,CAAA,UAAA,CAAA;AAC7B,QAAA,IAAA,CAAK,aAAaA,uBAAY,EAAA,CAAA;AAE9B,QAAK,IAAA,CAAA,IAAA,CAAK,UAAU,IAAI,CAAA,CAAA;AAAA,OAG5B,MAAA;AACI,QAAK,IAAA,CAAA,IAAA,CAAK,UAAU,IAAI,CAAA,CAAA;AAAA,OAC5B;AAAA,KACJ;AAAA,GACJ;AAAA,EAEA,OAAO,WACP,EAAA;AACI,IAAK,IAAA,CAAA,WAAA,GAAc,WAAe,IAAA,IAAA,CAAK,UAAW,CAAA,IAAA,CAAA;AAClD,IAAK,IAAA,CAAA,SAAA,EAAA,CAAA;AAEL,IAAK,IAAA,CAAA,IAAA,CAAK,UAAU,IAAI,CAAA,CAAA;AAAA,GAC5B;AAAA,EAEA,OACA,GAAA;AACI,IAAK,IAAA,CAAA,IAAA,CAAK,WAAW,IAAI,CAAA,CAAA;AAEzB,IAAA,IAAA,CAAK,KAAQ,GAAA,IAAA,CAAA;AACb,IAAA,IAAA,CAAK,UAAa,GAAA,IAAA,CAAA;AAElB,IAAA,IAAA,CAAK,kBAAmB,EAAA,CAAA;AAAA,GAC5B;AACJ;;;;"}