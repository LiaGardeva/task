{"version":3,"file":"getGlobalBounds.js","sources":["../../../../src/rendering/scene/bounds/getGlobalBounds.ts"],"sourcesContent":["import { Matrix } from '../../../maths/Matrix';\nimport { updateLocalTransform } from '../utils/updateLocalTransform';\n\nimport type { Container } from '../Container';\nimport type { Bounds } from './Bounds';\n\nexport function getGlobalBounds(target: Container, skipUpdateTransform: boolean, bounds: Bounds): Bounds\n{\n    bounds.clear();\n\n    let parentTransform;\n\n    if (target.parent)\n    {\n        if (!skipUpdateTransform)\n        {\n            // TODO new Matrix.. EEEWW! pooling..\n            parentTransform = updateTransformBackwards(target, new Matrix());\n        }\n        else\n        {\n            parentTransform = target.parent.worldTransform;\n        }\n    }\n    else\n    {\n        parentTransform = Matrix.IDENTITY;\n    }\n\n    // then collect them...\n\n    _getGlobalBounds(target, bounds, parentTransform, skipUpdateTransform);\n\n    if (!bounds.isValid)\n    {\n        bounds.set(0, 0, 0, 0);\n    }\n\n    return bounds;\n}\n\nexport function _getGlobalBounds(\n    target: Container,\n    bounds: Bounds,\n    parentTransform: Matrix,\n    skipUpdateTransform: boolean,\n): void\n{\n    if (!target.visible || !target.measurable) return;\n\n    let worldTransform: Matrix;\n\n    if (!skipUpdateTransform)\n    {\n        if (target.didChange)\n        {\n            updateLocalTransform(target.localTransform, target);\n        }\n\n        worldTransform = Matrix.shared.appendFrom(target.localTransform, parentTransform).clone();\n    }\n    else\n    {\n        worldTransform = target.worldTransform;\n    }\n\n    const parentBounds = bounds;\n    const preserveBounds = !!target.effects.length;\n\n    if (preserveBounds)\n    {\n        // TODO - cloning bounds is slow, we should have a pool (its on the todo list!)\n        bounds = bounds.clone();\n    }\n\n    if (target.view)\n    {\n        bounds.setMatrix(worldTransform);\n\n        target.view.addBounds(bounds);\n    }\n\n    for (let i = 0; i < target.children.length; i++)\n    {\n        _getGlobalBounds(target.children[i], bounds, worldTransform, skipUpdateTransform);\n    }\n\n    if (preserveBounds)\n    {\n        for (let i = 0; i < target.effects.length; i++)\n        {\n            target.effects[i].addBounds?.(bounds);\n        }\n\n        parentBounds.addBounds(bounds);\n    }\n}\n\nexport function updateTransformBackwards(target: Container, parentTransform: Matrix)\n{\n    const parent = target.parent;\n\n    if (parent)\n    {\n        updateTransformBackwards(parent, parentTransform);\n\n        if (parent.didChange)\n        {\n            updateLocalTransform(parent.localTransform, parent);\n        }\n\n        parentTransform.append(parent.localTransform);\n    }\n\n    return parentTransform;\n}\n\n"],"names":["Matrix","updateLocalTransform"],"mappings":"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"}